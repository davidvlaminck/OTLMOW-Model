name: Zip source code
run-name: Zip source code for ${{ github.sha }}
concurrency:
  group: coverage_and_zip_master
  cancel-in-progress: false
on:
  pull_request:
    branches:
      - master
  workflow_dispatch:
  workflow_run:
    workflows: [Create release]
    types:
      - completed

jobs:
  check_model_update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Determine source run id
        id: determine
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          RUN_ID=$(python3 - <<'PY'
import os, json, urllib.request, sys
repo = os.environ['GITHUB_REPOSITORY']
event_path = os.environ.get('GITHUB_EVENT_PATH')
with open(event_path) as f:
    event = json.load(f)
# If this workflow was triggered by a workflow_run (Create release), event['workflow_run'] is the release run
wf = event.get('workflow_run', {}) or {}
head_sha = wf.get('head_sha')
if head_sha:
    # find the auto_update run that has the same head_sha
    url = f"https://api.github.com/repos/{repo}/actions/workflows/auto_update.yml/runs?per_page=50"
    req = urllib.request.Request(url, headers={
        'Authorization': f"token {os.environ['GITHUB_TOKEN']}",
        'Accept': 'application/vnd.github.v3+json'
    })
    with urllib.request.urlopen(req) as resp:
        data = json.load(resp)
    runs = data.get('workflow_runs') or []
    for r in runs:
        if r.get('head_sha') == head_sha:
            print(r.get('id'))
            sys.exit(0)
# fallback: latest auto_update run
url = f"https://api.github.com/repos/{repo}/actions/workflows/auto_update.yml/runs?per_page=1"
req = urllib.request.Request(url, headers={
    'Authorization': f"token {os.environ['GITHUB_TOKEN']}",
    'Accept': 'application/vnd.github.v3+json'
})
with urllib.request.urlopen(req) as resp:
    data = json.load(resp)
runs = data.get('workflow_runs') or []
if runs:
    print(runs[0]['id'])
else:
    print('')
PY
)
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Download model update status artifact
        uses: actions/download-artifact@v4
        with:
          name: model-update-status
          path: ./
          repository: ${{ github.repository }}
          run-id: ${{ steps.determine.outputs.run_id }}
      - name: Read model update status
        id: read_status
        run: |
          STATUS=$(cat model_update_status.txt | grep MODEL_UPDATED | cut -d= -f2)
          echo "model_updated=$STATUS" >> $GITHUB_OUTPUT

  zip_source_code:
    needs: check_model_update
    if: (needs.check_model_update.outputs.model_updated == 'true' && github.event.workflow_run.conclusion == 'success') || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'
    timeout-minutes: 10
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    steps:
      - uses: actions/checkout@v4
      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            uv-${{ runner.os }}-
      - name: zip files
        run: |
          rm -rf source.zip
          zip -v -r source.zip ./otlmow_model
      - name: Commit files
        run: |
          git pull
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "Zipped source code"
          git push
