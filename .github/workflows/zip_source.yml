name: Zip source code
run-name: Zip source code for ${{ github.sha }}
concurrency:
  group: coverage_and_zip_master
  cancel-in-progress: false
on:
  pull_request:
    branches:
      - master
  workflow_dispatch:
  workflow_run:
    workflows: [Create release]
    types:
      - completed

jobs:
  check_model_update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download model update status artifact
        uses: actions/download-artifact@v4
        with:
          name: model-update-status
          path: ./
      - name: Read model update status
        id: read_status
        run: |
          STATUS=$(cat model_update_status.txt | grep MODEL_UPDATED | cut -d= -f2)
          echo "model_updated=$STATUS" >> $GITHUB_OUTPUT

  zip_source_code:
    needs: check_model_update
    if: (needs.check_model_update.outputs.model_updated == 'true' && github.event.workflow_run.conclusion == 'success') || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'
    timeout-minutes: 10
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    steps:
      - uses: actions/checkout@v4
      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            uv-${{ runner.os }}-
      - name: zip files
        run: |
          rm -rf source.zip
          zip -v -r source.zip ./otlmow_model
      - name: Commit files
        run: |
          git pull
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "Zipped source code"
          git push
